# AGENTS.md

Instructions for AI coding agents working with this codebase.

## Project Overview

This is a **Rush monorepo** for OpenFront-related projects. The primary package is OpenFrontIO, a multiplayer strategy game maintained as a git worktree.

**Stack:**
- Build System: Rush 5.164.0
- Package Manager: pnpm 9.15.9 (managed by Rush)
- Runtime: Node.js 20.x or 22.x (both LTS)
- Languages: TypeScript, JavaScript

## Do

- **Use Rush commands** for all operations: `rush update`, `rush build`, `rush test`
- **Use `rushx`** to run package.json scripts from within a package directory
- **Use `workspace:^` protocol** for internal package dependencies in package.json
- **Run `rush update`** after any package.json changes
- **Use TypeScript strict mode** with explicit types (avoid `any`)
- **Use ES modules** (`import`/`export`)
- **Follow existing naming conventions** in each package
- **Keep packages one level deep** within category directories: `apps/[name]/`, `packages/[name]/`, `external/[name]/`, `experiments/[name]/`
- **Run linting and tests** before committing changes
- **Use Prettier** for formatting (2-space indentation, single quotes, trailing commas)
- **Use ESLint flat config** format (eslint.config.js)
- **Write tests** for new features
- **Keep commits focused** and atomic with clear messages

## Don't

- Don't use npm/yarn directly - always use Rush commands
- Don't modify rush.json without understanding the impact
- Don't add packages at wrong depth (must be exactly one level in category)
- Don't use `any` type unless absolutely necessary
- Don't add new dependencies without checking if existing ones can be used
- Don't skip `rush update` after package.json changes
- Don't modify .github/workflows manually (auto-generated by Rush)
- Don't commit node_modules, dist, or build artifacts
- Don't hardcode values that should be configurable

## Commands

### Common Rush Commands

```bash
# Install/update all dependencies (run after package.json changes)
rush update

# Build all packages
rush build

# Build specific package and dependencies
rush build --to <package-name>

# Rebuild everything (clean + build)
rush rebuild

# Run tests
rush test

# List all packages
rush list

# Add dependency to a package (run from package directory)
rush add -p <dependency-name>

# Remove dependency
rush remove -p <dependency-name>
```

### Package-Specific Commands

```bash
# Navigate to a package
cd apps/[package-name]  # or packages/, external/, experiments/

# Run package.json scripts
rushx build
rushx test
rushx lint
rushx dev
```

### OpenFrontIO Commands

```bash
cd external/openfrontio

rushx build-dev      # Development build
rushx build-prod     # Production build
rushx dev            # Start dev server (client + server)
rushx test           # Run tests
rushx lint           # Check linting
rushx lint:fix       # Auto-fix linting issues
rushx format         # Format code with Prettier
```

## Repository Structure

```
openfront-projects/
├── apps/              # Application packages
├── packages/          # Internal library packages
├── experiments/       # Experimental packages
├── external/          # External packages (git worktrees)
│   └── openfrontio/   # OpenFrontIO game (git worktree)
├── common/            # Rush shared configuration
│   ├── config/rush/   # Rush config files
│   └── scripts/       # Monorepo automation scripts
├── docs/              # Documentation
├── rush.json          # Main Rush configuration
└── AGENTS.md          # This file
```

**Package Organization Rules:**
- Packages must be **exactly one level deep** in category directories
- Examples: `apps/map-editor/`, `external/openfrontio/`, `packages/my-lib/`
- Configured in rush.json: `projectFolderMinDepth: 2`, `projectFolderMaxDepth: 3`

## Adding New Packages

1. **Create package directory** (one level deep in category):
   ```bash
   mkdir -p apps/[package-name]
   # or packages/, experiments/, external/
   ```

2. **Create package.json**:
   ```json
   {
     "name": "@openfront/package-name",
     "version": "1.0.0",
     "private": true,
     "scripts": {
       "build": "tsc",
       "test": "jest"
     }
   }
   ```

3. **Register in rush.json** (add to projects array):
   ```json
   {
     "packageName": "@openfront/package-name",
     "projectFolder": "apps/package-name"
   }
   ```

4. **Install dependencies**:
   ```bash
   rush update
   ```

See `docs/ADDING_PACKAGES.md` for detailed guide.

## Git Worktree Management

OpenFrontIO at `external/openfrontio` is a git worktree (separate repository):
- **Repository:** https://github.com/bosconian-dynamics/OpenFrontIO
- **Upstream:** https://github.com/openfrontio/OpenFrontIO

### Setup (one-time)
```bash
./scripts/setup-worktrees.sh  # Linux/macOS
# or
.\scripts\setup-worktrees.ps1  # Windows
```

### Pull Updates
```bash
cd external/openfrontio
git pull
```

### Push Changes
```bash
cd external/openfrontio
git add .
git commit -m "Your changes"
git push origin main
```

See `docs/WORKTREE_WORKFLOW.md` for detailed guide.

## OpenFrontIO Package Details

Located at `external/openfrontio/`:
- **Frontend:** PixiJS, TypeScript, Webpack, Tailwind CSS
- **Backend:** Express, WebSockets, TypeScript
- **Testing:** Jest
- **Linting:** ESLint (flat config)
- **Formatting:** Prettier

## Code Style

### TypeScript
- Strict mode enabled
- Prefer explicit types over `any`
- Use ES modules (`import`/`export`)
- Follow existing naming conventions

### Formatting (Prettier)
- 2-space indentation
- Single quotes for strings
- Trailing commas in multi-line structures
- Run `rushx format` from package directory

### Linting (ESLint)
- Flat config format (eslint.config.js)
- Run `rushx lint` to check
- Run `rushx lint:fix` to auto-fix

### Testing
- Write tests for new features
- Use descriptive test names
- Mock external dependencies
- Maintain test coverage

## Workflow

1. **Make changes** in package directory
2. **Run linting**: `rushx lint` or `rushx lint:fix`
3. **Run tests**: `rushx test`
4. **Build**: `rush build` or `rushx build`
5. **Commit** with clear, descriptive message
6. **Push** and create pull request

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Rush not found | Install globally: `npm install -g @microsoft/rush` |
| Package not found | Check rush.json registration, then run `rush update` |
| Dependency mismatch | Run `rush update --full` |
| Build failures | Check package build logs, ensure dependencies installed |
| Worktree missing | Run `./scripts/setup-worktrees.sh` (or `.ps1` on Windows) |

## Documentation

- **docs/MONOREPO.md** - Comprehensive monorepo guide
- **docs/ADDING_PACKAGES.md** - Step-by-step package creation
- **docs/WORKTREE_WORKFLOW.md** - Git worktree workflow details
- **README.md** - Quick start and overview

## Resources

- [Rush Documentation](https://rushjs.io/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [PixiJS Documentation](https://pixijs.com/)
- [OpenFrontIO Fork](https://github.com/bosconian-dynamics/OpenFrontIO)
- [OpenFrontIO Upstream](https://github.com/openfrontio/OpenFrontIO)
